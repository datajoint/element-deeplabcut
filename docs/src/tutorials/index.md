# Tutorials

## Installation

Installation of the Element requires an integrated development environment and database.
Instructions to setup each of the components can be found on the
[User Instructions](datajoint.com/docs/elements/user-instructions) page.  These
instructions use the example
[workflow for Element DeepLabCut](https://github.com/datajoint/workflow-deeplabcut),
which can be modified for a user's specific experimental requirements.  This example
workflow uses four Elements (Lab, Animal, Session, and DeepLabCut) to construct a
complete pipeline, and is able to ingest experimental metadata and run model training
and inference.

The [DeepLabCut (DLC) website](https://deeplabcut.github.io/DeepLabCut/README.html) has a
rich library of resources for downloading the software and understanding its various
features. This includes getting started with their software (see
[links below](#steps-to-run-the-element)).

## Steps to run the Element

The Element assumes you:

1. Have
   [downloaded and installed DLC](https://deeplabcut.github.io/DeepLabCut/docs/installation.html).
2. Have a DLC project folder on your machine. You can declare a project either
   from the
   [DLC GUI](https://deeplabcut.github.io/DeepLabCut/docs/PROJECT_GUI.html#video-demos-how-to-launch-and-run-the-project-manager-gui)
   or via a
   [terminal](https://deeplabcut.github.io/DeepLabCut/docs/standardDeepLabCut_UserGuide.html#deeplabcut-in-the-terminal).
3. Have labeled data in your DLC project folder. Again, this can be done via
   [the GUI](https://youtu.be/JDsa8R5J0nQ?t=94)
   or a
   [terminal](https://deeplabcut.github.io/DeepLabCut/docs/standardDeepLabCut_UserGuide.html#deeplabcut-in-the-terminal).

With these steps in place, you can then use the materials below to start training
and pose estimation inferences. Training starts by configuring parameters in the
`train` schema, and launching training in the `ModelTraining` table. When you're happy
with the state of a model, you can insert it into the `Model` table, and pair it with
videos to trigger pose estimation inferences via the `PoseEstimationTask` table
in the `model` schema. See [Element Architecture](./concepts/#element-architecture)
for a full list of table functions.

### Videos

The [Element DeepLabCut tutorial](https://www.youtube.com/watch?v=8FDjTuQ52gQ) gives an
overview of the workflow files and notebooks as well as core concepts related to
DeepLabCut.

[![YouTube tutorial](https://img.youtube.com/vi/8FDjTuQ52gQ/0.jpg)](https://www.youtube.com/watch?v=8FDjTuQ52gQ)

### Notebooks

Each of the notebooks in the workflow
([download here](https://github.com/datajoint/workflow-deeplabcut/tree/main/notebooks)
steps through ways to interact with the Element itself. For convenience, these notebooks
are also rendered as part of this site.
To try out Elements
notebooks in an online Jupyter environment with access to example data, visit
[CodeBook](https://codebook.datajoint.io/). (DeepLabCut notebooks coming soon!)

- [Data Download](./00-DataDownload_Optional.ipynb)
   highlights how to use DataJoint tools to download a sample model for trying out the Element.
- [Configure](./01-Configure.ipynb)
   helps configure your local DataJoint installation to point to the correct database.
- [Workflow Structure](./02-WorkflowStructure_Optional.ipynb) demonstrates the table
   architecture of the Element and key DataJoint basics for interacting with these
   tables.
- [Process](./03-Process.ipynb) steps through adding data to these tables and launching
   key DeepLabCut features, like model training.
- [Automate](./04-Automate_Optional.ipynb)
   highlights the same steps as above, but utilizing all built-in automation tools.
- [Visualization](./05-Visualization_Optional.ipynb)
   demonstrates how to fetch data from the Element to generate figures and label data.
- [Drop schemas](./06-Drop_Optional.ipynb)
   provides the steps for dropping all the tables to start fresh.
- `07-NWB-Export` (coming soon!) will describe how to export into NWB files. For now,
  see [below](./#nwb-export)
- [Alternate Dataset](./09-AlternateDataset.ipynb)
   does all of the above, but with a
   [dataset from DeepLabCut](https://github.com/DeepLabCut/DeepLabCut/tree/master/examples/openfield-Pranav-2018-10-30).

## Data Export to Neurodata Without Borders (NWB)

The `export/nwb.py` module calls [DLC2NWB](https://github.com/DeepLabCut/DLC2NWB/) to
save output generated by Element DeepLabCut as NWB files.
The main function, `dlc_session_to_nwb`, contains a flag to control calling a parallel
function in
[Element Session](https://github.com/datajoint/element-session/blob/main/element_session/export/nwb.py).

Before using, please install [DLC2NWB](https://github.com/DeepLabCut/DLC2NWB/)

```console
pip install dlc2nwb
```

Then, call the export function using keys from the `PoseEstimation` table.

```python
from element_deeplabcut import model
from element_session import session
from element_deeplabcut.export import dlc_session_to_nwb

session_key = (session.Session & CONDITION)
pose_key = (model.PoseEstimation & session_key).fetch1('KEY')
dlc_session_to_nwb(pose_key, use_element_session=True, session_kwargs=SESSION_KWARGS)
```

Here, `CONDITION` should uniquely identify a session and `SESSION_KWARGS` can be any of
the items described in the docstring of `element_session.export.nwb.session_to_nwb`
as a dictionary.

As DLC2NWB does not currently offer a separate function for generating `PoseEstimation`
objects (see [ndx-pose](https://github.com/rly/ndx-pose)), the current solution is to
allow DLC2NWB to write to disk, and optionally rewrite this file using metadata provided
by the export function in Element Session.
